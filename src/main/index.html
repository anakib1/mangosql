<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL-like Database GUI</title>
    <style>
        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .success {
            color: green;
            border: 1px solid green;
        }

        .error {
            color: red;
            border: 1px solid red;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
<h1>SQL-like Database GUI</h1>

<!-- Form to create a table -->
<h2>Create a Table</h2>
<form id="create-table-form">
    <label for="table_name">Table Name:</label>
    <input type="text" id="table_name" name="table_name" required>
    <br>

    <h3>Table Schema</h3>
    <div id="schema-fields">
        <div class="schema-field">
            <input type="text" placeholder="Column Name" class="column-name" required>
            <select class="column-type">
                <option value="integer">Integer</option>
                <option value="real">Real</option>
                <option value="string">String</option>
                <option value="char">Char</option>
                <option value="date">Date</option>
            </select>
            <button type="button" class="remove-column" onclick="removeColumn(this)">Remove</button>
        </div>
    </div>
    <button type="button" id="add-column">Add Column</button>
    <br>
    <button type="submit">Create Table</button>
</form>
<div id="create-table-message" class="message"></div>

<!-- Form to insert a row into a table -->
<h2>Insert a Row</h2>
<form id="insert-row-form">
    <label for="table_name_insert">Table Name:</label>
    <input type="text" id="table_name_insert" name="table_name_insert" required>
    <button type="button" id="load-schema">Load Table Schema</button>
    <br>
    <div id="row-fields"></div>
    <button type="submit" style="display:none;" id="insert-row-btn">Insert Row</button>
</form>
<div id="insert-row-message" class="message"></div>

<!-- Form to display a table -->
<h2>Display a Table</h2>
<form id="display-table-form">
    <label for="table_name_display">Table Name:</label>
    <input type="text" id="table_name_display" name="table_name_display" required>
    <br>
    <button type="submit">Display Table</button>
</form>
<div id="display-table-message" class="message"></div>
<table id="table-display" style="display:none;">
    <thead id="table-head"></thead>
    <tbody id="table-body"></tbody>
</table>

<!-- Form to get the product of two tables -->
<h2>Product of Two Tables</h2>
<form id="product-tables-form">
    <label for="table1">Table 1 Name:</label>
    <input type="text" id="table1" name="table1" required>
    <br>
    <label for="table2">Table 2 Name:</label>
    <input type="text" id="table2" name="table2" required>
    <br>
    <button type="submit">Get Product</button>
</form>
<div id="product-message" class="message"></div>
<table id="product-display" style="display:none;">
    <thead id="product-head"></thead>
    <tbody id="product-body"></tbody>
</table>

<script>
    // Add schema field on "Add Column" button click
    document.getElementById('add-column').addEventListener('click', function () {
        const schemaFields = document.getElementById('schema-fields');
        const div = document.createElement('div');
        div.className = 'schema-field';
        div.innerHTML = `
                <input type="text" placeholder="Column Name" class="column-name" required>
                <select class="column-type">
                    <option value="integer">Integer</option>
                    <option value="real">Real</option>
                    <option value="string">String</option>
                    <option value="char">Char</option>
                    <option value="date">Date</option>
                </select>
                <button type="button" class="remove-column" onclick="removeColumn(this)">Remove</button>
            `;
        schemaFields.appendChild(div);
    });

    // Remove column field
    function removeColumn(button) {
        button.parentElement.remove();
    }

    // Handle table creation form
    document.getElementById('create-table-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const tableName = document.getElementById('table_name').value;

        // Collect schema from input fields
        const schema = {};
        document.querySelectorAll('.schema-field').forEach(field => {
            const columnName = field.querySelector('.column-name').value;
            const columnType = field.querySelector('.column-type').value;
            schema[columnName] = columnType;
        });

        fetch('/api/create_table', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({table_name: tableName, schema: schema})
        })
            .then(response => response.json())
            .then(data => {
                const messageElement = document.getElementById('create-table-message');
                if (data.error) {
                    messageElement.textContent = data.error;
                    messageElement.className = 'message error';
                } else {
                    messageElement.textContent = data.message;
                    messageElement.className = 'message success';
                }
                messageElement.style.display = 'block';
            });
    });

    // Load table schema for inserting a row
    // Load table schema for inserting a row
    document.getElementById('load-schema').addEventListener('click', function (event) {
        event.preventDefault();
        const tableName = document.getElementById('table_name_insert').value;

        fetch(`/api/display_table/${tableName}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Dynamically create input fields for each column
                const rowFields = document.getElementById('row-fields');
                rowFields.innerHTML = ''; // Clear any previous fields

                const schema = data.schema;
                for (const column in schema) {
                    const div = document.createElement('div');
                    div.innerHTML = `
                <label>${column} (${schema[column]}):</label>
                <input type="text" name="${column}" data-type="${schema[column]}" required>
            `;
                    rowFields.appendChild(div);
                }

                document.getElementById('insert-row-btn').style.display = 'inline-block';
            });
    });


    // Handle row insertion
    document.getElementById('insert-row-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const tableName = document.getElementById('table_name_insert').value;

        // Collect row data from input fields and convert to the correct type based on the schema
        const rowData = {};
        document.querySelectorAll('#row-fields input').forEach(input => {
            const fieldName = input.name;
            const fieldValue = input.value;

            // Get the field type from the input's dataset (added when loading schema)
            const fieldType = input.dataset.type;

            // Convert the fieldValue to the correct type
            if (fieldType === 'integer') {
                rowData[fieldName] = parseInt(fieldValue, 10);
            } else if (fieldType === 'real') {
                rowData[fieldName] = parseFloat(fieldValue);
            } else {
                rowData[fieldName] = fieldValue;  // Keep as string for other types
            }
        });

        fetch('/api/insert_row', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({table_name: tableName, row: rowData})
        })
            .then(response => response.json())
            .then(data => {
                const messageElement = document.getElementById('insert-row-message');
                if (data.error) {
                    messageElement.textContent = data.error;
                    messageElement.className = 'message error';
                } else {
                    messageElement.textContent = data.message;
                    messageElement.className = 'message success';
                }
                messageElement.style.display = 'block';
            });
    });


    // The other functionality for displaying tables and products remains unchanged
    document.getElementById('display-table-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const tableName = document.getElementById('table_name_display').value;

        fetch(`/api/display_table/${tableName}`)
            .then(response => response.json())
            .then(data => {
                const tableElement = document.getElementById('table-display');
                const messageElement = document.getElementById('display-table-message');
                if (data.error) {
                    messageElement.textContent = data.error;
                    messageElement.className = 'message error';
                    tableElement.style.display = 'none';
                } else {
                    const tableHead = document.getElementById('table-head');
                    const tableBody = document.getElementById('table-body');
                    tableHead.innerHTML = '';
                    tableBody.innerHTML = '';

                    const schema = Object.keys(data.schema);
                    const headerRow = document.createElement('tr');
                    schema.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col;
                        headerRow.appendChild(th);
                    });
                    tableHead.appendChild(headerRow);

                    data.rows.forEach(row => {
                        const rowElement = document.createElement('tr');
                        schema.forEach(col => {
                            const td = document.createElement('td');
                            td.textContent = row[col];
                            rowElement.appendChild(td);
                        });
                        tableBody.appendChild(rowElement);
                    });

                    messageElement.style.display = 'none';
                    tableElement.style.display = 'table';
                }
            });
    });

    document.getElementById('product-tables-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const table1 = document.getElementById('table1').value;
        const table2 = document.getElementById('table2').value;

        fetch(`/api/product/${table1}/${table2}`)
            .then(response => response.json())
            .then(data => {
                const tableElement = document.getElementById('product-display');
                const messageElement = document.getElementById('product-message');
                if (data.error) {
                    messageElement.textContent = data.error;
                    messageElement.className = 'message error';
                    tableElement.style.display = 'none';
                } else {
                    const tableHead = document.getElementById('product-head');
                    const tableBody = document.getElementById('product-body');
                    tableHead.innerHTML = '';
                    tableBody.innerHTML = '';

                    if (data.rows.length > 0) {
                        const schema = Object.keys(data.rows[0]);
                        const headerRow = document.createElement('tr');
                        schema.forEach(col => {
                            const th = document.createElement('th');
                            th.textContent = col;
                            headerRow.appendChild(th);
                        });
                        tableHead.appendChild(headerRow);

                        data.rows.forEach(row => {
                            const rowElement = document.createElement('tr');
                            schema.forEach(col => {
                                const td = document.createElement('td');
                                td.textContent = row[col];
                                rowElement.appendChild(td);
                            });
                            tableBody.appendChild(rowElement);
                        });

                        messageElement.style.display = 'none';
                        tableElement.style.display = 'table';
                    } else {
                        messageElement.textContent = 'No rows found for product.';
                        messageElement.className = 'message error';
                        tableElement.style.display = 'none';
                    }
                }
            });
    });
</script>
</body>
</html>
